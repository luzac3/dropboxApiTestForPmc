(()=>{"use strict";var t=function(){function t(t,e){this.strAction=t,this.modalWindowElement=e}return t.prototype.showModal=function(){var t=this.strAction+"中。しばらくお待ちください。";this.modalWindowElement.show(),this.modalWindowElement.empty(),this.createModalContents(t)},t.prototype.showResult=function(t){var e;void 0===t&&(t=""),e=""!=t?this.strAction+"に失敗しました。\n"+t:this.strAction+"が完了しました。",this.modalWindowElement.empty(),this.createModalContents(e),this.createBottonInModal("OK")},t.prototype.setStrAction=function(t){this.strAction=t},t.prototype.createModalContents=function(t){var e=document.createElement("p");$(e).html(t),$(e).append(this.modalWindowElement)},t.prototype.createBottonInModal=function(t){var e=this,n=document.createElement("button");n.type="button",$(n).on("click",(function(){e.hideModal()})),$(n).html(t),$(n).append(this.modalWindowElement)},t.prototype.hideModal=function(){this.modalWindowElement.hide(),this.modalWindowElement.empty()},t}(),e=function(){function t(){}return t.prototype.setCookie=function(t,e,n){void 0===n&&(n=0);var o="";if(n){var i=new Date;i.setTime(i.getTime()+n),o="; expires="+i.toUTCString()}document.cookie=t+"="+(e||"")+o+"; path=/"},t.prototype.getCookie=function(t){var e;return document.cookie.split(";").forEach((function(n){if((e=n.split("="))[0].trim()==t)return e[1].trim()})),""},t.prototype.delCookie=function(t){document.cookie=t+"=;max-age=0"},t}(),n=function(){function t(){var t=new e;this.accessToken=t.getCookie("accessToken"),""==this.accessToken&&(location.href="./oAuth.html")}return t.prototype.uploadFile=function(e){var n=this;return new Promise((function(o,i){var r,a={Authorization:"Bearer "+n.accessToken,"Dropbox-API-Arg":'{"path": "'+e.name+'","mode": "add","autorename": true,"mute": false}'},s=new FileReader;s.readAsDataURL(e),s.onload=function(){null!=s.result?(r=s.result,(new t).sendRequest("https://content.dropboxapi.com/2/files/upload",r,"application/octet-stream",a).then((function(){alert("ok"),o(1)}),(function(){alert("ng"),i(0)}))):alert("ファイル情報の取得に失敗しました")}}))},t.prototype.downloadFile=function(t){var e=this;return new Promise((function(n,o){var i={Authorization:"Bearer "+e.accessToken,"Dropbox-API-Arg":'{"path": "'+t+'","mode": "add","autorename": true,"mute": false}'};e.sendRequest("https://content.dropboxapi.com/2/files/download","","",i).then((function(){alert("ok"),n(1)}),(function(){alert("ng"),o(0)}))}))},t.prototype.deleteFiles=function(t){var e=this;return new Promise((function(n,o){var i='{"ids":'+t+"}",r={Authorization:"Bearer "+e.accessToken};e.sendRequest("https://content.dropboxapi.com/2/file_requests/delete",i,"Content-Type: application/json",r).then((function(){alert("ok"),n(1)}),(function(){alert("ng"),o(0)}))}))},t.prototype.getFileList=function(){var t=this;return new Promise((function(e,n){var o,i={Authorization:"Bearer "+t.accessToken};t.sendRequest("https://content.dropboxapi.com/2/file_requests/list","","Content-Type: application/json",i).then((function(t){o=JSON.stringify(t),e(o)}),(function(){alert("ng"),n(0)}))}))},t.prototype.sendRequest=function(t,e,n,o){return new Promise((function(i,r){$.ajax({url:t,type:"post",data:e,processData:!1,contentType:n,headers:o}).then((function(t){i(t)}),(function(){r("error")})).catch((function(t){}))}))},t}(),o=function(){function e(){}return e.prototype.setList=function(t){(new n).getFileList().then((function(t){console.log(t)}),(function(t){alert("erorr")})).catch((function(t){alert("erorr")})),console.log(t)},e.prototype.reSetList=function(o,i){o.on("change",(function(){var o=new t("リスト再表示処理",$(".modal_window")),r=new n;o.showModal(),r.getFileList().then((function(t){if(Array.isArray(t)){o.showResult();var n=new e;console.log(t),n.setList(i)}else o.showResult("未知のエラー")}),(function(t){o.showResult(t.error)})).catch((function(t){o.showResult(t.message)}))}))},e.prototype.uploadFile=function(e,o){e.on("click",(function(){var e,i=o.prop("files");if(null!=i){e=i[0];var r=new t("アップロード",$(".modal_window")),a=new n;try{r.showModal()}catch(t){}a.uploadFile(e).then((function(t){"number"==typeof t?r.showResult():r.showResult("未知のエラーが発生しました")}),(function(t){r.showResult(t.error)})).catch((function(t){r.showResult(t.message)}))}else alert("ファイルが登録されていません")}))},e.prototype.downloadFile=function(e){e.on("click",(function(e){var o=new t("ダウンロード",$(".modal_window")),i=new n;try{o.showModal()}catch(t){}i.downloadFile($(e.target).data("filename")).then((function(t){"number"==typeof t?o.showResult():o.showResult("未知のエラーが発生しました")}),(function(t){o.showResult(t.error)})).catch((function(t){o.showResult(t.message)}))}))},e.prototype.deleteFiles=function(e,o){e.on("click",(function(){var e,i,r=o.length+"件削除します。\nよろしいですか？";if(window.confirm(r)){var a=new t("削除",$(".modal_window")),s=new n;try{a.showModal()}catch(t){}if(e=o.find("input[type='checkbox']").filter(":checked"),i=[],e.each((function(t,e){i.push($(e).data("filename"))})),i.length)return void alert("1件も選択されていません");s.deleteFiles(i).then((function(t){"number"==typeof t?a.showResult():a.showResult("未知のエラーが発生しました")}),(function(t){a.showResult(t.error)})).catch((function(t){a.showResult(t.message)}))}}))},e}(),i=function(){function t(t,e,n){this.dropAreaElement=t,this.fileInformationElement=e,this.uploadFileElement=n}return t.prototype.setDragAndDropEvent=function(){var t=this;this.dropAreaElement.on("dragover",(function(e){e.stopPropagation(),e.preventDefault(),t.dropAreaElement[0].style.background="#e1e7f0"})),this.dropAreaElement.on("dragleave",(function(e){e.stopPropagation(),e.preventDefault(),t.dropAreaElement[0].style.background="#ffffff"})),this.dropAreaElement.on("drop",(function(e){var n,o;e.stopPropagation(),e.preventDefault(),t.dropAreaElement[0].style.background="#ffffff",null!=e.originalEvent&&null!=e.originalEvent.dataTransfer?((n=e.originalEvent.dataTransfer.files).length>1&&alert("複数ファイルアップロードには対応しておりません"),null!=t.uploadFileElement[0].files&&(o=n[0],t.uploadFileElement.prop("files")[0]=o)):alert("未知のエラーです")})),this.dropAreaElement.on("click",(function(){t.uploadFileElement.trigger("click")})),this.uploadFileElement.on("change",(function(){var e,n,o=t.uploadFileElement.prop("files")[0],i=new r(o.size);e=i.getConvertedSize(),n=i.getUnit(),t.fileInformationElement.html(o.name+"("+e+n+")")}))},t}(),r=function(){function t(t){this.kb=1024,this.mb=Math.pow(this.kb,2),this.gb=Math.pow(this.kb,3),t>=this.gb?(this.unit="Gb",this.convertedSize=Math.floor(t/this.kb*100)/100):t>=this.mb?(this.unit="Mb",this.convertedSize=Math.floor(t/this.mb*100)/100):t>=this.kb?(this.unit="Kb",this.convertedSize=Math.floor(t/this.kb*100)/100):(this.unit="b",this.convertedSize=t)}return t.prototype.getUnit=function(){return this.unit},t.prototype.getConvertedSize=function(){return this.convertedSize},t}();$(document).ready((function(){var t=$(".reSetButton"),e=$(".file_list"),n=$(".upload_button"),r=$(".upload_file"),a=$("file_list").find(".file_name"),s=$(".delete_button"),l=$(".upload_area"),c=$(".file_information"),u=new o,f=new i(l,c,r);u.setList(e),u.reSetList(t,e),u.uploadFile(n,r),u.downloadFile(a),u.deleteFiles(s,a),f.setDragAndDropEvent()}))})();